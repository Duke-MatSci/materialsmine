version: '3'
services:
  mongo:
    image: 'mongo:4.4'
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MM_MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MM_MONGO_PWD}
      - MONGO_DEVS=${MONGO_DEVS}
      - MONGO_DEV_PWD=${MONGO_DEV_PWD}
      - MONGO_PORT=${MONGO_PORT}
      - MM_DB=${MM_DB}
    ports:
      - '27017:27017'
    volumes:
      - ./mockDB/db:/data/db
      - ./mockDB/restore:/restore
      - ./mockDB/log:/var/log/mongodb
      - ./mockDB/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh
  es:
    image: 'elasticsearch:8.1.0'
    container_name: es
    restart: always
    environment:
      - node.name=es01
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - '9200:9200'
    volumes:
      - ./mockDB/es:/usr/share/elasticsearch/data
  proxy:
    depends_on:
      - api
      # - client
      - kg
    restart: always
    build:
      dockerfile: Dockerfile.dev
      context: ./nginx
    ports:
      - '80:80'
  api:
    depends_on:
      - mongo
      - es
    build:
      dockerfile: Dockerfile.dev
      context: ./resfulservice
    volumes:
      - /app/node_modules
      - ./resfulservice:/app
    environment:
      - DB_USERNAME=${MONGO_DEVS}
      - DB_PASSWORD=${MONGO_DEV_PWD}
      - MM_DB=${MM_DB}
      - MONGO_ADDRESS=${MONGO_ADDRESS}
      - MONGO_PORT=${MONGO_PORT}
      - TKNS=${TKNS}
  # client:
  #   stdin_open: true
  #   environment:
  #     - CHOKIDAR_USEPOLLING=true
  #   build:
  #     dockerfile: Dockerfile.dev
  #     context: ./app
  #   volumes:
  #     - /app/node_modules
  #     - ./app:/app
  kg:
    image: 'stain/jena-fuseki:4.0.0'
    restart: always
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JVM_ARGS=-Xmx3g
    ports:
      - '3030:3030'
    volumes:
      - ./mockDB/fuseki:/fuseki
volumes:
  mockDB: